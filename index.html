<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>UDVERI — мини-приложение</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="color-scheme" content="dark light" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    /* (весь твой CSS остаётся без изменений) */
  </style>
</head>
<body>
  <div class="container">
    <!-- Твои секции: tab-menu, tab-request и т.д. -->
    <!-- ... -->

    <!-- Кнопка "Отправить заявку" -->
    <button class="btn ok" onclick="sendRequest()">Отправить заявку</button>
  </div>

  <script>
    // Telegram WebApp init
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();
    tg.setBackgroundColor("#0e0f12");
    tg.setHeaderColor("#0e0f12");

    // --- Helpers ---
    function qs(id){ return document.getElementById(id); }
    function show(id){ qs(id).classList.remove('hidden'); }
    function hide(id){ qs(id).classList.add('hidden'); }

    const tabs = ["menu","request","success","tariffs","profile"];
    function openTab(tab){
      tabs.forEach(t => (t===tab?show('tab-'+t):hide('tab-'+t)));
      ['menu','request','tariffs','profile'].forEach(t => {
        const el = qs('btn-'+t);
        if (!el) return;
        el.classList.toggle('active', t===tab);
      });
      const url = new URL(window.location.href);
      url.searchParams.set('tab', tab);
      window.history.replaceState({}, "", url.toString());
    }

    function decodePayload() {
      const url = new URL(window.location.href);
      const p = url.searchParams.get('p');
      const fromTab = url.searchParams.get('tab') || undefined;
      let payload = {};
      if (p) {
        try {
          const b64 = p.replace(/-/g, '+').replace(/_/g, '/');
          const json = decodeURIComponent(escape(window.atob(b64)));
          payload = JSON.parse(json);
        } catch(e) {}
      }
      return { payload, fromTab };
    }

    function fillProfile(p){
      qs('pname').textContent = p.first_name || "—";
      const parts = [];
      if (p.street) parts.push(p.street);
      if (p.house) parts.push('д. '+p.house);
      if (p.flat) parts.push('кв. '+p.flat);
      if (p.entrance) parts.push('подъезд '+p.entrance);
      if (p.floor) parts.push('этаж '+p.floor);
      qs('paddr').textContent = parts.length ? parts.join(', ') : "—";
      qs('pphone').textContent = p.phone || "—";
    }

    function sendRequest(){
      const bags = parseInt(qs('bags')?.value || "1", 10);
      const time = (qs('time')?.value || "").trim();
      const door = (qs('door')?.value || "").trim();
      const comment = (qs('comment')?.value || "").trim();

      const payload = {
        type: "create_request",
        bags,
        comment: [time, door, comment].filter(Boolean).join("; ")
      };

      try {
        tg.HapticFeedback?.impactOccurred("medium");
        tg.sendData(JSON.stringify(payload));
      } catch(e) {
        console.error("Ошибка отправки WebAppData:", e);
      }

      openTab("success");
    }

    // --- Init ---
    const { payload, fromTab } = decodePayload();
    fillProfile(payload);
    openTab(fromTab || payload.tab || "menu");
  </script>
</body>
</html>

