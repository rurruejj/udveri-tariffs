<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>UDVERI ‚Äî –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="color-scheme" content="dark light" />
  <style>
    :root {
      --bg: #0e0f12;
      --bg2:#111318;
      --card:#15171c;
      --line:#23262d;
      --text:#ffffff;
      --muted:#a7adb7;
      --btn:#2a2d34;
      --ok:#1d7e3a;
      --danger:#7e1d1d;
    }
    * { box-sizing:border-box; }
    html, body { height:100%; }
    body { margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; background:var(--bg); color:var(--text); }
    .container { padding: 16px 16px 88px; max-width: 720px; margin: 0 auto; }
    .hidden { display:none; }
    .h2 { font-size:20px; margin:0 0 12px; font-weight:600; }
    .muted { color:var(--muted); font-size:14px; }
    .card { background:var(--card); border:1px solid var(--line); border-radius:16px; padding:16px; margin:12px 0; }
    .btn { display:block; width:100%; padding:14px 16px; border-radius:14px; border:0; background:var(--btn); color:var(--text); font-size:16px; cursor:pointer; }
    .btn:active { transform: translateY(1px); }
    .btn.ok { background:var(--ok); }
    .btn.danger { background:var(--danger); }
    .row { display:flex; gap:10px; }
    .row > .btn { flex:1; }
    .input, .select, .textarea {
      width:100%; padding:12px 14px; border-radius:12px; border:1px solid var(--line);
      background:#1a1c22; color:var(--text); margin:8px 0 16px; font-size:15px;
    }
    .textarea { resize:vertical; min-height:90px; }
    .kvs { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }

    .tabs {
      position:fixed; left:0; right:0; bottom:0; height:72px;
      background:var(--bg2); border-top:1px solid var(--line);
      display:flex; justify-content:space-around; align-items:center; padding:8px env(safe-area-inset-right) calc(8px + env(safe-area-inset-bottom)) 
env(safe-area-inset-left);
    }
    .tabbtn { flex:1; text-align:center; color:#9aa0a6; font-size:13px; line-height:1.1; }
    .tabbtn b { display:block; font-size:18px; margin-bottom:4px; }
    .tabbtn.active { color:#fff; }
  </style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <div class="container">
    <!-- MENU -->
    <section id="tab-menu">
      <h2 class="h2">–ú–µ–Ω—é</h2>
      <div class="card">
        <p class="muted">–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è:</p>
        <div class="row">
          <button class="btn" onclick="openTab('request')">–û—Å—Ç–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</button>
          <button class="btn" onclick="openTab('profile')">–ü—Ä–æ—Ñ–∏–ª—å</button>
        </div>
      </div>
      <div class="card">
        <p class="muted">–¢–∞—Ä–∏—Ñ—ã —Å–µ–π—á–∞—Å</p>
        <p><b>0 ‚ÇΩ</b> –∑–∞ –≤—ã–Ω–æ—Å. –ü–æ–º–æ–≥–∏—Ç–µ –Ω–∞–º –≤—ã—Ä–∞—Å—Ç–∏ ‚Äî —Ä–∞—Å—Å–∫–∞–∂–∏—Ç–µ –¥—Ä—É–∑—å—è–º ‚ù§Ô∏è</p>
        <button class="btn" onclick="openTab('tariffs')">–ü–æ–¥—Ä–æ–±–Ω–µ–µ –æ —Ç–∞—Ä–∏—Ñ–∞—Ö</button>
      </div>
    </section>

    <!-- REQUEST -->
    <section id="tab-request" class="hidden">
      <h2 class="h2">–ó–∞—è–≤–∫–∞ –Ω–∞ –≤—ã–Ω–æ—Å</h2>
      <label class="muted">–°–∫–æ–ª—å–∫–æ –ø–∞–∫–µ—Ç–æ–≤</label>
      <select id="bags" class="select">
        <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
      </select>

      <div class="kvs">
        <div>
          <label class="muted">–í—Ä–µ–º—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
          <input id="time" class="input" type="text" placeholder="–ù–∞–ø—Ä.: —Å–µ–≥–æ–¥–Ω—è –∫ 20:00" />
        </div>
        <div>
          <label class="muted">–ü–æ–¥—ä–µ–∑–¥/–¥–æ–º–æ—Ñ–æ–Ω (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
          <input id="door" class="input" type="text" placeholder="–ö–æ–¥ 1234#" />
        </div>
      </div>

      <label class="muted">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
      <textarea id="comment" class="textarea" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –∑–∞–±—Ä–∞—Ç—å –ø–∞–∫–µ—Ç—ã —É –¥–≤–µ—Ä–∏, —è –Ω–µ –¥–æ–º–∞"></textarea>

      <button class="btn ok" onclick="sendRequest()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</button>
      <div id="status" class="muted" style="margin-top:8px;"></div>
    </section>

    <!-- REQUEST SUCCESS -->
    <section id="tab-success" class="hidden">
      <div class="card">
        <h2 class="h2">‚úÖ –ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞</h2>
        <p class="muted">–ú—ã –ø—Ä–∏—Å–ª–∞–ª–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤ —á–∞—Ç. –ú–æ–∂–µ—Ç–µ –≤–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é –∏–ª–∏ –æ—Ñ–æ—Ä–º–∏—Ç—å –Ω–æ–≤—É—é –∑–∞—è–≤–∫—É.</p>
      </div>
      <div class="row">
        <button class="btn" onclick="openTab('menu')">–í –º–µ–Ω—é</button>
        <button class="btn" onclick="openTab('request')">–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞</button>
      </div>
    </section>

    <!-- TARIFFS -->
    <section id="tab-tariffs" class="hidden">
      <h2 class="h2">–¢–∞—Ä–∏—Ñ—ã</h2>
      <div class="card">
        <p>–ü—Ä–æ–º–æ-—Å—Ç–æ–∏–º–æ—Å—Ç—å: <b>0 ‚ÇΩ</b>.</p>
        <p class="muted">–°–µ—Ä–≤–∏—Å –≤ –∑–∞–ø—É—Å–∫–µ, —Å–æ–±–∏—Ä–∞–µ–º –±–∞–∑—É –∫–ª–∏–µ–Ω—Ç–æ–≤. –°–ø–∞—Å–∏–±–æ, —á—Ç–æ —Å –Ω–∞–º–∏!</p>
      </div>
      <button class="btn" onclick="openTab('menu')">–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é</button>
    </section>

    <!-- PROFILE -->
    <section id="tab-profile" class="hidden">
      <h2 class="h2">–ü—Ä–æ—Ñ–∏–ª—å</h2>
      <div class="card">
        <div class="muted">–ò–º—è</div>
        <div id="pname">‚Äî</div>

        <div class="muted" style="margin-top:12px">–ê–¥—Ä–µ—Å</div>
        <div id="paddr">‚Äî</div>

        <div class="muted" style="margin-top:12px">–¢–µ–ª–µ—Ñ–æ–Ω</div>
        <div id="pphone">‚Äî</div>

        <button class="btn" style="margin-top:16px" onclick="editAddress()">–ò–∑–º–µ–Ω–∏—Ç—å –∞–¥—Ä–µ—Å</button>
      </div>
      <button class="btn" onclick="openTab('menu')">–í –º–µ–Ω—é</button>
    </section>
  </div>

  <!-- Bottom navigation -->
  <nav class="tabs">
    <div id="btn-menu"    class="tabbtn" onclick="openTab('menu')"><b>üè†</b>–ú–µ–Ω—é</div>
    <div id="btn-request" class="tabbtn" onclick="openTab('request')"><b>üß∫</b>–ó–∞—è–≤–∫–∞</div>
    <div id="btn-tariffs" class="tabbtn" onclick="openTab('tariffs')"><b>üí≥</b>–¢–∞—Ä–∏—Ñ—ã</div>
    <div id="btn-profile" class="tabbtn" onclick="openTab('profile')"><b>üë§</b>–ü—Ä–æ—Ñ–∏–ª—å</div>
  </nav>

  <script>
    const tg = window.Telegram?.WebApp;
    if (tg) {
      tg.expand();
      tg.setBackgroundColor("#0e0f12");
      tg.setHeaderColor("#0e0f12");
      tg.ready();
    }

    function qs(id){ return document.getElementById(id); }
    function show(id){ qs(id).classList.remove('hidden'); }
    function hide(id){ qs(id).classList.add('hidden'); }

    const tabs = ["menu","request","success","tariffs","profile"];
    function openTab(tab){
      tabs.forEach(t => (t===tab?show('tab-'+t):hide('tab-'+t)));
      ['menu','request','tariffs','profile'].forEach(t=>{
        const el = qs('btn-'+t);
        if (!el) return;
        el.classList.toggle('active', t===tab);
      });
      const url = new URL(window.location.href);
      url.searchParams.set('tab', tab);
      window.history.replaceState({}, "", url.toString());

      // –ø—Ä–∏ –∑–∞—Ö–æ–¥–µ –≤ –ø—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–∏–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–∑ payload
      if (tab === 'profile') {
        fillProfileFromPayload();
      }
    }

    // ===== PAYLOAD –∏–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ p =====
    function decodePayload() {
      const url = new URL(window.location.href);
      const p = url.searchParams.get('p');
      const fromTab = url.searchParams.get('tab') || undefined;
      let payload = {};
      if (p) {
        try {
          const b64 = p.replace(/-/g, '+').replace(/_/g, '/');
          // –ø–æ–¥–¥–µ—Ä–∂–∫–∞ Unicode
          const json = decodeURIComponent(escape(window.atob(b64)));
          payload = JSON.parse(json);
        } catch(e) {
          try {
            payload = JSON.parse(atob(p));
          } catch(_) {}
        }
      }
      return { payload, fromTab };
    }

    function buildAddress(p) {
      const parts = [];
      if (p.street)   parts.push(p.street);
      if (p.house)    parts.push("–¥." + p.house);
      if (p.flat)     parts.push("–∫–≤." + p.flat);
      if (p.entrance) parts.push("–ø–æ–¥—ä–µ–∑–¥ " + p.entrance);
      if (p.floor)    parts.push("—ç—Ç–∞–∂ " + p.floor);
      if (p.city)     parts.push(p.city);
      return parts.length ? parts.join(", ") : "‚Äî";
    }

    const { payload, fromTab } = decodePayload();

    function fillProfileFromPayload() {
      // –∏–º—è
      const name = (payload.first_name || "‚Äî") + (payload.last_name ? (" " + payload.last_name) : "");
      qs('pname').textContent = name.trim() || "‚Äî";
      // —Ç–µ–ª–µ—Ñ–æ–Ω
      qs('pphone').textContent = payload.phone || "‚Äî";
      // –∞–¥—Ä–µ—Å
      qs('paddr').textContent = buildAddress(payload);
    }

    // –ø–µ—Ä–≤–∏—á–Ω–∞—è –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤ –ø—Ä–æ—Ñ–∏–ª—å –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    fillProfileFromPayload();

    // ===== –û–¢–ü–†–ê–í–ö–ê –ó–ê–Ø–í–ö–ò (—á–µ—Ä–µ–∑ tg.sendData, –±–µ–∑ HTTP) =====
    function sendRequest(){
      const status = qs('status');
      const bags = parseInt(qs('bags').value || "1", 10);
      const time = (qs('time').value || "").trim();
      const door = (qs('door').value || "").trim();
      const comment = (qs('comment').value || "").trim();

      const mergedComment = [time, door, comment].filter(Boolean).join("; ");

      const data = {
        type: "create_request",
        bags,
        comment: mergedComment
      };

      try {
        if (tg && tg.sendData) {
          status.textContent = "‚è≥ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞—è–≤–∫—É‚Ä¶";
          tg.sendData(JSON.stringify(data));
          openTab('success');
          setTimeout(()=>{ try { tg.close(); } catch(e){} }, 600);
        } else {
          status.textContent = "‚ùå –û—Ç–∫—Ä–æ–π—Ç–µ —á–µ—Ä–µ–∑ Telegram Mini App";
        }
      } catch (e) {
        console.error(e);
        status.textContent = "‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.";
      }
    }

    // ===== –ò–ó–ú–ï–ù–ò–¢–¨ –ê–î–†–ï–° =====
    function editAddress() {
      const data = { type: "edit_address" };
      try {
        if (tg && tg.sendData) {
          tg.sendData(JSON.stringify(data));
          // –ó–∞–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ ‚Äî –¥–∞–ª—å—à–µ –±–æ—Ç —Å–ø—Ä–æ—Å–∏—Ç –∞–¥—Ä–µ—Å –ø–æ —à–∞–≥–∞–º
          setTimeout(()=>{ try { tg.close(); } catch(e){} }, 200);
        } else {
          alert("–û—Ç–∫—Ä–æ–π—Ç–µ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–∑ Telegram, —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å –∞–¥—Ä–µ—Å");
        }
      } catch(e) {
        console.error(e);
      }
    }

    // –æ—Ç–∫—Ä—ã–≤–∞–µ–º –Ω—É–∂–Ω—É—é –≤–∫–ª–∞–¥–∫—É –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    openTab(fromTab || payload.tab || "menu");
  </script>
</body>
</html>
