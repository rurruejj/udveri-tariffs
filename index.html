<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>UDVERI ‚Äî –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</title>
  <meta name="viewport" 
content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="color-scheme" content="dark light" />
  <style>
    :root {
      --bg: #0d0f13;
      --bg2: rgba(18, 20, 26, 0.7);
      --card: rgba(30, 33, 41, 0.6);
      --line: rgba(255, 255, 255, 0.08);
      --text: #ffffff;
      --muted: #a7adb7;
      --btn: rgba(255, 255, 255, 0.08);
      --ok: linear-gradient(135deg,#1db954,#1aa34a);
      --danger: linear-gradient(135deg,#ff4d4d,#a10000);
      --primary: linear-gradient(135deg,#4a90e2,#357ab7);
      --radius: 18px;
      --shadow: 0 8px 24px rgba(0,0,0,0.4);
      --transition: all 0.25s ease;
    }
    * { box-sizing:border-box; }
    html, body { height:100%; }
    body {
      margin:0;
      font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, 
Arial;
      background: var(--bg);
      background-image: radial-gradient(circle at 20% 20%, #1a1d25, 
transparent 50%),
                        radial-gradient(circle at 80% 80%, #111318, 
transparent 40%);
      color:var(--text);
    }
    .container { padding: 20px 20px 88px; max-width: 720px; margin: 0 
auto; animation: fadeIn 0.5s ease; }
    .hidden { display:none; }
    .h2 { font-size:22px; margin:0 0 14px; font-weight:600; }
    .muted { color:var(--muted); font-size:14px; }
    .card {
      background:var(--card);
      backdrop-filter: blur(12px);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:20px;
      margin:16px 0;
      box-shadow: var(--shadow);
      animation: slideUp 0.4s ease;
    }
    .btn {
      display:block;
      width:100%;
      padding:14px 18px;
      border-radius:var(--radius);
      border:0;
      background:var(--btn);
      color:var(--text);
      font-size:16px;
      font-weight:500;
      cursor:pointer;
      transition: var(--transition);
    }
    .btn:hover { background: rgba(255,255,255,0.12); }
    .btn:active { transform: scale(0.97); }
    .btn.ok { background:var(--ok); color:#fff; }
    .btn.danger { background:var(--danger); color:#fff; }
    .row { display:flex; gap:12px; }
    .row > .btn { flex:1; }
    .input, .select, .textarea {
      width:100%;
      padding:14px 16px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,0.05);
      backdrop-filter: blur(8px);
      color:var(--text);
      margin:10px 0 18px;
      font-size:15px;
      transition: var(--transition);
    }
    .input:focus, .select:focus, .textarea:focus {
      border-color:#4a90e2;
      outline:none;
      box-shadow:0 0 0 3px rgba(74,144,226,0.2);
    }
    .textarea { resize:vertical; min-height:100px; }
    .kvs { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .tabs {
      position:fixed;
      left:0;
      right:0;
      bottom:0;
      height:72px;
      background:var(--bg2);
      border-top:1px solid var(--line);
      display:flex;
      justify-content:space-around;
      align-items:center;
      padding:8px env(safe-area-inset-right) calc(8px + 
env(safe-area-inset-bottom)) env(safe-area-inset-left);
      backdrop-filter: blur(16px);
      box-shadow: 0 -4px 16px rgba(0,0,0,0.3);
    }
    .tabbtn {
      flex:1;
      text-align:center;
      color:#9aa0a6;
      font-size:13px;
      line-height:1.2;
      transition: var(--transition);
    }
    .tabbtn b {
      display:block;
      font-size:20px;
      margin-bottom:4px;
    }
    .tabbtn.active { color:#fff; transform: scale(1.05); }
    .profile-header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 16px;
    }
    .avatar {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: #2a2e38;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      font-weight: 600;
      color: #fff;
      overflow: hidden;
      flex-shrink: 0;
    }
    .avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    @keyframes fadeIn { from {opacity:0;} to {opacity:1;} }
    @keyframes slideUp { from {opacity:0; transform:translateY(10px);} to 
{opacity:1; transform:translateY(0);} }

    /* –°—Ç–∏–ª—å –∫–∞—Ä—Ç—ã */
    #map {
      width: 100%;
      height: 300px; /* –º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å */
      margin-top: 20px;
      border-radius: 18px;
      overflow: hidden;
    }
  </style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <div class="container">
    <!-- MENU -->
    <section id="tab-menu">
      <h2 class="h2">–ú–µ–Ω—é</h2>
      <div class="card">
        <p class="muted">–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è:</p>
        <div class="row">
          <button class="btn" onclick="openTab('request')">üß∫ –û—Å—Ç–∞–≤–∏—Ç—å 
–∑–∞—è–≤–∫—É</button>
          <button class="btn" onclick="openTab('profile')">üë§ 
–ü—Ä–æ—Ñ–∏–ª—å</button>
        </div>
      </div>
      <div class="card">
        <p class="muted">–¢–∞—Ä–∏—Ñ—ã —Å–µ–π—á–∞—Å</p>
        <p><b>0 ‚ÇΩ</b> –∑–∞ –≤—ã–Ω–æ—Å. –ü–æ–º–æ–≥–∏—Ç–µ –Ω–∞–º –≤—ã—Ä–∞—Å—Ç–∏ ‚Äî —Ä–∞—Å—Å–∫–∞–∂–∏—Ç–µ –¥—Ä—É–∑—å—è–º 
‚ù§Ô∏è</p>
        <button class="btn" onclick="openTab('tariffs')">–ü–æ–¥—Ä–æ–±–Ω–µ–µ –æ 
—Ç–∞—Ä–∏—Ñ–∞—Ö</button>
      </div>
    </section>

    <!-- REQUEST -->
    <section id="tab-request" class="hidden">
      <h2 class="h2">–ó–∞—è–≤–∫–∞ –Ω–∞ –≤—ã–Ω–æ—Å</h2>
      <label class="muted">–°–∫–æ–ª—å–∫–æ –ø–∞–∫–µ—Ç–æ–≤</label>
      <select id="bags" class="select">
        
<option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
      </select>
      <div class="kvs">
        <div>
          <label class="muted">–í—Ä–µ–º—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
          <input id="time" class="input" type="text" placeholder="–ù–∞–ø—Ä.: 
—Å–µ–≥–æ–¥–Ω—è –∫ 20:00" />
        </div>
        <div>
          <label class="muted">–ü–æ–¥—ä–µ–∑–¥/–¥–æ–º–æ—Ñ–æ–Ω (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
          <input id="door" class="input" type="text" placeholder="–ö–æ–¥ 
1234#" />
        </div>
      </div>
      <label class="muted">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
      <textarea id="comment" class="textarea" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 
–∑–∞–±—Ä–∞—Ç—å –ø–∞–∫–µ—Ç—ã —É –¥–≤–µ—Ä–∏, —è –Ω–µ –¥–æ–º–∞"></textarea>
      <button class="btn ok" onclick="sendRequest()">üöÄ –û—Ç–ø—Ä–∞–≤–∏—Ç—å 
–∑–∞—è–≤–∫—É</button>
      <div id="status" class="muted" style="margin-top:8px;"></div>
    </section>

    <!-- REQUEST SUCCESS -->
    <section id="tab-success" class="hidden">
      <div class="card">
        <h2 class="h2">‚úÖ –ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞</h2>
        <p class="muted">–ú—ã –ø—Ä–∏—Å–ª–∞–ª–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤ —á–∞—Ç. –ú–æ–∂–µ—Ç–µ –≤–µ—Ä–Ω—É—Ç—å—Å—è 
–≤ –º–µ–Ω—é –∏–ª–∏ –æ—Ñ–æ—Ä–º–∏—Ç—å –Ω–æ–≤—É—é –∑–∞—è–≤–∫—É.</p>
      </div>
      <div class="row">
        <button class="btn" onclick="openTab('menu')">üè† –í –º–µ–Ω—é</button>
        <button class="btn" onclick="openTab('request')">üß∫ –ù–æ–≤–∞—è 
–∑–∞—è–≤–∫–∞</button>
      </div>
    </section>

    <!-- TARIFFS -->
    <section id="tab-tariffs" class="hidden">
      <h2 class="h2">–¢–∞—Ä–∏—Ñ—ã</h2>

      <!-- –ï–¥–∏–Ω–æ—Ä–∞–∑–æ–≤—ã–π –≤—ã–Ω–æ—Å -->
      <div class="card">
        <p><b>–ï–¥–∏–Ω–æ—Ä–∞–∑–æ–≤—ã–π –≤—ã–Ω–æ—Å</b></p>
        <p>–°—Ç–æ–∏–º–æ—Å—Ç—å: <b>100 ‚ÇΩ</b></p>
        <p class="muted">–û–¥–Ω–æ—Ä–∞–∑–æ–≤–∞—è —É—Å–ª—É–≥–∞ –ø–æ –≤—ã–Ω–æ—Å—É –ø–∞–∫–µ—Ç–æ–≤.</p>
        <button class="btn ok">–í—ã–±—Ä–∞—Ç—å</button>
      </div>

      <!-- –ú–µ—Å—è—á–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ —á–µ—Ä–µ–∑ 3 –¥–Ω—è -->
      <div class="card">
        <p><b>–ú–µ—Å—è—á–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ (—á–µ—Ä–µ–∑ 3 –¥–Ω—è)</b></p>
        <p>–ë–µ–∑–ª–∏–º–∏—Ç–Ω—ã–π –≤—ã–Ω–æ—Å: <b>399 ‚ÇΩ/–º–µ—Å</b></p>
        <p class="muted">–ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞ —Å—Ä–∞–∑—É, —Å–ª–µ–¥—É—é—â–∏–π –≤—ã–Ω–æ—Å –≤–æ–∑–º–æ–∂–µ–Ω 
—á–µ—Ä–µ–∑ 3 –¥–Ω—è –ø–æ—Å–ª–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ.</p>
        <button class="btn ok">–í—ã–±—Ä–∞—Ç—å</button>
      </div>

      <!-- –ú–µ—Å—è—á–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å -->
      <div class="card">
        <p><b>–ú–µ—Å—è—á–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ (–∫–∞–∂–¥—ã–π –¥–µ–Ω—å)</b></p>
        <p>–ë–µ–∑–ª–∏–º–∏—Ç–Ω—ã–π –≤—ã–Ω–æ—Å: <b>599 ‚ÇΩ/–º–µ—Å</b></p>
        <p class="muted">–ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞ —Å—Ä–∞–∑—É, –∑–∞—è–≤–∫–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –∫–∞–∂–¥—ã–π 
–¥–µ–Ω—å.</p>
        <button class="btn ok">–í—ã–±—Ä–∞—Ç—å</button>
      </div>

      <button class="btn" onclick="openTab('menu')">–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ 
–º–µ–Ω—é</button>
    </section>

    <!-- PROFILE -->
    <section id="tab-profile" class="hidden">
      <h2 class="h2">–ü—Ä–æ—Ñ–∏–ª—å</h2>
      <div class="card">
        <div class="profile-header">
          <div class="avatar" id="pavatar">üë§</div>
          <div>
            <div class="muted">–ò–º—è</div>
            <div id="pname">‚Äî</div>
          </div>
        </div>
        <div class="muted" style="margin-top:12px">–ê–¥—Ä–µ—Å</div>
        <div id="paddr">‚Äî</div>
        <div class="muted" style="margin-top:12px">–¢–µ–ª–µ—Ñ–æ–Ω</div>
        <div id="pphone">‚Äî</div>
      </div>
      <button class="btn" onclick="openTab('menu')">üè† –í –º–µ–Ω—é</button>
      <button class="btn ok" onclick="openBotChat()">‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å 
–∞–¥—Ä–µ—Å</button>
    </section>

    <!-- MAP -->
    <section id="tab-map" class="hidden">
      <h2 class="h2">–ö–∞—Ä—Ç–∞</h2>
      <div id="map"></div>
    </section>
  </div>

  <!-- Bottom navigation -->
  <nav class="tabs">
    <div id="btn-menu" class="tabbtn" 
onclick="openTab('menu')"><b>üè†</b>–ú–µ–Ω—é</div>
    <div id="btn-request" class="tabbtn" 
onclick="openTab('request')"><b>üß∫</b>–ó–∞—è–≤–∫–∞</div>
    <div id="btn-tariffs" class="tabbtn" 
onclick="openTab('tariffs')"><b>üí≥</b>–¢–∞—Ä–∏—Ñ—ã</div>
    <div id="btn-profile" class="tabbtn" 
onclick="openTab('profile')"><b>üë§</b>–ü—Ä–æ—Ñ–∏–ª—å</div>
    <div id="btn-map" class="tabbtn" 
onclick="openTab('map')"><b>üó∫</b>–ö–∞—Ä—Ç–∞</div>
  </nav>

  <!-- –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç—ã -->
  <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU"></script>

  <script>
    const tg = window.Telegram?.WebApp;
    if (tg) {
      tg.expand();
      tg.setBackgroundColor("#0d0f13");
      tg.setHeaderColor("#0d0f13");
      tg.ready();
    }

    function qs(id){ return document.getElementById(id); }
    function show(id){ qs(id).classList.remove('hidden'); }
    function hide(id){ qs(id).classList.add('hidden'); }

    const tabs = ["menu","request","success","tariffs","profile","map"];
    let payload = {};
    let mapInstance;

    function openTab(tab){
      tabs.forEach(t => (t===tab?show('tab-'+t):hide('tab-'+t)));
      ['menu','request','tariffs','profile','map'].forEach(t=>{
        const el = qs('btn-'+t);
        if (!el) return;
        el.classList.toggle('active', t===tab);
      });
      const url = new URL(window.location.href);
      url.searchParams.set('tab', tab);
      window.history.replaceState({}, "", url.toString());

      if (tab === 'profile') {
        const user = tg?.initDataUnsafe?.user || {};
        const name = (payload.first_name || user.first_name || "") +
          ((payload.last_name || user.last_name) ? " " + 
(payload.last_name || user.last_name) : "");
        qs('pname').textContent = name || "‚Äî";
        qs('pphone').textContent = (payload.phone || "").trim() || "‚Äî";

        // –ê–≤–∞—Ç–∞—Ä–∫–∞
        const avatarEl = qs('pavatar');
        if (user.photo_url) {
          avatarEl.innerHTML = `<img src="${user.photo_url}" 
alt="avatar">`;
        } else {
          const initials = ((user.first_name?.[0] || "") + 
(user.last_name?.[0] || "")).toUpperCase() || "üë§";
          avatarEl.textContent = initials;
        }

        function fmtAddr(p){
          const parts = [];
          if (p.street) parts.push(p.street);
          if (p.house) parts.push("–¥." + p.house);
          if (p.flat) parts.push("–∫–≤." + p.flat);
          if (p.entrance) parts.push("–ø–æ–¥—ä–µ–∑–¥ " + p.entrance);
          if (p.floor) parts.push("—ç—Ç–∞–∂ " + p.floor);
          return parts.join(", ");
        }
        qs('paddr').textContent = fmtAddr(payload) || "‚Äî";
      }

      // –ü–æ–¥–≥–æ–Ω –∫–∞—Ä—Ç—ã –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å–∫—Ä—ã—Ç–æ–π –≤–∫–ª–∞–¥–∫–∏
      if (tab === 'map' && mapInstance) {
        mapInstance.container.fitToViewport();
      }
    }

    function decodePayload() {
      const url = new URL(window.location.href);
      const p = url.searchParams.get('p');
      const fromTab = url.searchParams.get('tab') || undefined;
      let pl = {};
      if (p) {
        try {
          const b64 = p.replace(/-/g, '+').replace(/_/g, '/');
          const json = decodeURIComponent(escape(window.atob(b64)));
          pl = JSON.parse(json);
        } catch(e) {}
      }
      return { payload: pl, fromTab };
    }

    function sendRequest(){
      const status = qs('status');
      const bags = parseInt(qs('bags').value || "1", 10);
      const time = (qs('time').value || "").trim();
      const door = (qs('door').value || "").trim();
      const comment = (qs('comment').value || "").trim();
      const user = tg?.initDataUnsafe?.user || {};
      const data = {
        bags,
        comment: [time, door, comment].filter(Boolean).join("; "),
        profile: {
          username: user.username || "‚Äî",
          first_name: user.first_name || "‚Äî",
          last_name: user.last_name || "",
          phone: payload.phone || user.phone_number || "‚Äî",
          street: payload.street || "",
          house: payload.house || "",
          flat: payload.flat || "",
          entrance: payload.entrance || "",
          floor: payload.floor || ""
        }
      };
      status.textContent = "‚è≥ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞—è–≤–∫—É‚Ä¶";
      fetch("/api/awq", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ initData: tg?.initData, ...data })
      })
      .then(r => r.json())
      .then(resp => {
        if (resp.ok) {
          status.textContent = "‚úÖ –ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!";
          openTab('success');
          setTimeout(()=>{ try { tg.close(); } catch(e){} }, 500);
        } else {
          status.textContent = "‚ùå –û—à–∏–±–∫–∞: " + (resp.error || 
"–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ");
        }
      })
      .catch(err => {
        status.textContent = "‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.";
      });
    }

    function openBotChat() {
      if (tg) tg.close(); // –∑–∞–∫—Ä—ã–≤–∞–µ–º –º–∏–Ω–∏–∞–ø–ø
      
tg.openTelegramLink("https://t.me/udveri_ru_bot?start=edit_address");
    }
      
    const { payload: pl, fromTab } = decodePayload();
    payload = pl || payload;
    openTab(fromTab || payload.tab || "menu");

    // –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç–∞
    ymaps.ready(initMap);
    function initMap() {
      mapInstance = new ymaps.Map("map", {
        center: [55.774804, 37.475977], // —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –Ω–∞ –ø–µ—Ä–≤–æ–π —Ç–æ—á–∫–µ
        zoom: 14,
        controls: ['zoomControl']
      });

      // –¢–æ—á–∫–∏ –ø–æ–ª–∏–≥–æ–Ω–∞
      const coords = [
        [55.774804, 37.475977],
        [55.777298, 37.460325],
        [55.777592, 37.460419],
        [55.778472, 37.455083],
        [55.778536, 37.453932],
        [55.778490, 37.452619],
        [55.777751, 37.451305],
        [55.774891, 37.459357],
        [55.769636, 37.466284],
        [55.768881, 37.468826],
        [55.769058, 37.473586],
        [55.774804, 37.475977]
      ];

      // –†–∏—Å—É–µ–º –∑–µ–ª—ë–Ω—ã–π –ø–æ–ª–∏–≥–æ–Ω
      const polygon = new ymaps.Polygon([coords], {}, {
        fillColor: 'rgba(0, 255, 0, 0.3)', // –∑–µ–ª—ë–Ω–∞—è –ø—Ä–æ–∑—Ä–∞—á–Ω–∞—è –∑–∞–ª–∏–≤–∫–∞
        strokeColor: '#00FF00',            // –∑–µ–ª—ë–Ω–∞—è –≥—Ä–∞–Ω–∏—Ü–∞
        strokeWidth: 3
      });

      mapInstance.geoObjects.add(polygon);
    }
  </script>
</body>
</html>

