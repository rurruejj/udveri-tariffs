<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>UDVERI — мини-приложение</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="color-scheme" content="dark light" />
  <style>
    :root {
      --bg: #0e0f12;
      --bg2:#111318;
      --card:#15171c;
      --line:#23262d;
      --text:#ffffff;
      --muted:#a7adb7;
      --btn:#2a2d34;
      --ok:#1d7e3a;
      --danger:#7e1d1d;
    }
    * { box-sizing:border-box; }
    html, body { height:100%; }
    body { margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; background:var(--bg); color:var(--text); }
    .container { padding: 16px 16px 88px; max-width: 720px; margin: 0 auto; }
    .hidden { display:none; }
    .h2 { font-size:20px; margin:0 0 12px; font-weight:600; }
    .muted { color:var(--muted); font-size:14px; }
    .card { background:var(--card); border:1px solid var(--line); border-radius:16px; padding:16px; margin:16px 0; }
    .row { display:flex; gap:8px; flex-wrap:wrap; }
    .btn { flex:1; background:var(--btn); color:var(--text); border:none; padding:12px; border-radius:12px; font-size:16px; cursor:pointer; }
    .btn.active { outline:2px solid var(--ok); }
    .btn.ok { background:var(--ok); }
    .btn.danger { background:var(--danger); }
    input, textarea { width:100%; padding:12px; border-radius:12px; border:1px solid var(--line); background:var(--bg2); color:var(--text); margin:6px 0; font-size:16px; }
    textarea { resize:vertical; min-height:80px; }
  </style>
</head>
<body>
  <div class="container">

    <!-- MENU -->
    <section id="tab-menu">
      <h2 class="h2">Меню</h2>
      <div class="card">
        <p class="muted">Быстрые действия:</p>
        <div class="row">
          <button class="btn" onclick="openTab('request')">Оставить заявку</button>
          <button class="btn" onclick="openTab('profile')">Профиль</button>
        </div>
      </div>
      <div class="card">
        <p class="muted">Тарифы сейчас</p>
        <p><b>0 ₽</b> за вынос. Помогите нам протестировать сервис!</p>
      </div>
    </section>

    <!-- REQUEST -->
    <section id="tab-request" class="hidden">
      <h2 class="h2">Заявка</h2>
      <input id="bags" type="number" min="1" value="1" placeholder="Количество пакетов" />
      <input id="time" placeholder="Время, например 19:00" />
      <input id="door" placeholder="Домофон / подъезд / этаж" />
      <textarea id="comment" placeholder="Комментарий"></textarea>
      <button class="btn ok" onclick="sendRequest()">Отправить заявку</button>
      <div id="status" class="muted" style="margin-top:8px;"></div>
    </section>

    <!-- SUCCESS -->
    <section id="tab-success" class="hidden">
      <h2 class="h2">✅ Заявка отправлена</h2>
      <p>Спасибо! Мы скоро свяжемся с вами.</p>
      <button class="btn" onclick="openTab('menu')">В меню</button>
    </section>

    <!-- PROFILE -->
    <section id="tab-profile" class="hidden">
      <h2 class="h2">Профиль</h2>
      <div class="card">
        <div><b id="pname">—</b></div>
        <div class="muted" id="paddr">—</div>
        <div class="muted" id="pphone">—</div>
      </div>
    </section>

  </div>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    const tg = window.Telegram?.WebApp;
    if (tg) {
      tg.expand();
      tg.setBackgroundColor("#0e0f12");
      tg.setHeaderColor("#0e0f12");
      tg.ready();
    }

    function qs(id){ return document.getElementById(id); }
    function show(id){ qs(id).classList.remove('hidden'); }
    function hide(id){ qs(id).classList.add('hidden'); }

    const tabs = ["menu","request","success","tariffs","profile"];
    function openTab(tab){
      tabs.forEach(t => (t===tab?show('tab-'+t):hide('tab-'+t)));
      ['menu','request','tariffs','profile'].forEach(t=>{
        const el = qs('btn-'+t);
        if (!el) return;
        el.classList.toggle('active', t===tab);
      });
      const url = new URL(window.location.href);
      url.searchParams.set('tab', tab);
      window.history.replaceState({}, "", url.toString());
    }

    function decodePayload() {
      const url = new URL(window.location.href);
      const p = url.searchParams.get('p');
      const fromTab = url.searchParams.get('tab') || undefined;
      let payload = {};
      if (p) {
        try {
          const b64 = p.replace(/-/g, '+').replace(/_/g, '/');
          const json = decodeURIComponent(escape(window.atob(b64)));
          payload = JSON.parse(json);
        } catch(e) {}
      }
      return { payload, fromTab };
    }

    function fillProfile(p){
      qs('pname').textContent = p.first_name || "—";
      const parts = [];
      if (p.street) parts.push(p.street);
      if (p.house) parts.push('д. '+p.house);
      if (p.flat) parts.push('кв. '+p.flat);
      if (p.entrance) parts.push('подъезд '+p.entrance);
      if (p.floor) parts.push('этаж '+p.floor);
      qs('paddr').textContent = parts.length ? parts.join(', ') : "—";
      qs('pphone').textContent = p.phone || "—";
    }

    async function sendRequest(){
      const status = qs('status');
      const bags = parseInt(qs('bags').value || "1", 10);
      const time = (qs('time').value || "").trim();
      const door = (qs('door').value || "").trim();
      const comment = (qs('comment').value || "").trim();

      const { payload } = decodePayload();

      const body = {
        initData: tg?.initData || "",
        bags,
        comment: [time, door, comment].filter(Boolean).join("; "),
        street: payload.street || "",
        house: payload.house || "",
        flat: payload.flat || "",
        entrance: payload.entrance || "",
        floor: payload.floor || "",
        city: payload.city || "",
        phone: payload.phone || ""
      };

      try {
        status.textContent = "⏳ Отправляем заявку…";
        const r = await fetch("/api/awq", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });
        const data = await r.json();
        if (data.ok) {
          openTab('success');
          try { tg.close(); } catch(e){}
        } else {
          status.textContent = "❌ Ошибка: " + (data.error||"неизвестно");
        }
      } catch(e){
        console.error(e);
        status.textContent = "❌ Ошибка соединения";
      }
    }

    const { payload, fromTab } = decodePayload();
    fillProfile(payload);
    openTab(fromTab || payload.tab || "menu");
  </script>
</body>
</html>

